package ex6Consumer;
import java.io.FileInputStream;

public class Marketplace {
	
	class Writer extends Thread {
		 Buffer b;
		 FileInputStream fs;
		 public void run() {
			 int x;
			 try {
				 while ((x = fs.read()) != -1)
					 b.put((char) x);
				 b.put('\032');
			 } catch (Exception e) {
				 System.err.println("Cannot read");
				 System.exit(1);
			 }
		 }
		 
		 Writer(String fname, Buffer b) {
			 this.b = b;
			 try {
				 fs = new FileInputStream(fname);
				 System.out.println("Um novo produtor(" + this.getName() + ") nasceu, com este inventário: " + fname);
			 } catch (Exception e) {
				 fs = null;
				 System.err.println("Cannot open "+fname);
				 System.exit(1);
			 }
		 }
	} 
	
	class Reader extends Thread {
		Buffer b;
		public void run() {
			 char x;
			 while ((x = b.get()) != '\032')
				 System.out.print(x);
		}
		 
		Reader(Buffer b) {
			this.b = b;
			System.out.println("Um novo consumidor(" + this.getName() + ") nasceu.");
		}
	} 
	
	class Buffer {
		
		 final int MAXSIZE = 512;
		 char keep[];
		 int count, front, rear;
		 
		 public synchronized char get() {
			 while (count == 0)
				try {
					this.wait();
				} catch (InterruptedException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			 char x = keep[rear];
			 rear = (rear+1) % MAXSIZE;
			 count--;
			 this.notifyAll(); // that a space is now available
			 return x;
		 }
		 
		 public synchronized void put(char x) {
			 while (count == MAXSIZE)
				try {
					this.wait();
				} catch (InterruptedException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			 keep[front] = x;
			 front = (front+1) % MAXSIZE;
			 count++;
			 this.notifyAll(); // that an item is now available
		 }
		 
		 Buffer() {
			 System.out.println("Um novo marketplace(" + this.hashCode() + ") foi criado.");
			 keep = new char [MAXSIZE];
			 count = 0;
			 front = rear = 0;
		 }
		 		 
	} 
	
	 public static void main(String args[]) {
		 Buffer b = new Buffer();
		 Writer w1 = new Writer("entrada.txt",b);
		 Writer w2 = new Writer("entrada2.txt",b);
		 Reader r1 = new Reader(b);
		 Reader r2 = new Reader(b);
		 Reader r3 = new Reader(b);
		 
		 w1.run();
		 r1.run();
		 r2.run();
		 w2.run();
		 r3.run();
	 }

}
